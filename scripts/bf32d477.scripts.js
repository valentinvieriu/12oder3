"use strict";angular.module("12oder3App",["firebase","lodash","ngAnimate","ngTouch","ngRoute"]).config(["$routeProvider","$compileProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/admin",{templateUrl:"views/admin-dashboard.html",controller:"AdminDashboardCtrl"}).when("/admin-add-questions",{templateUrl:"views/admin-add-questions.html",controller:"AdminAddQuestionsCtrl"}).when("/play/:qid",{templateUrl:"views/play.html",controller:"PlayCtrl",resolve:{load:function($q,$route,data){var defer=$q.defer(),qid=$route.current.params.qid;return data.fBase.questions.$child(qid).$on("loaded",function(){defer.resolve("questions loaded")}),defer.promise}}}).when("/set-user/:userType",{template:"<h1>Setting user type ...</h1>",controller:"SetUserTypeCtrl"}).when("/dashboard",{templateUrl:"views/dashboard.html",controller:"DashboardCtrl"}).when("/play-dashboard/:qid",{templateUrl:"views/play-dashboard.html",controller:"PlayDashboardCtrl"}).when("/wait-dashboard",{templateUrl:"views/wait-dashboard.html",controller:"WaitDashboardCtrl"}).when("/wait",{templateUrl:"views/wait.html",controller:"WaitCtrl"}).when("/reset",{templateUrl:"views/reset.html",controller:"ResetCtrl"}).otherwise({redirectTo:"/"})}]).run(["data","$location","$rootScope","helpers","Localstorage",function(data,$location,$rootScope,helpers){$location.path();data.init(),(helpers.userType("user")||helpers.userType("dashboard"))&&($rootScope.playPage=helpers.userType("user")?data.fBase.playPage:data.fBase.playDashboard,$rootScope.playPage.$on("loaded",function(){var newRoute=$rootScope.playPage.$value;$location.path(newRoute)}),$rootScope.playPage.$on("change",function(){$location.path($rootScope.playPage.$value)}))}]),angular.module("12oder3App").controller("MainCtrl",["$scope","$location","$document","data","helpers","_","Uuids","Localstorage",function($scope,$location,$document,data,helpers,_,Uuids,Localstorage){$document.find("body").addClass("login"),$scope.name=Localstorage.get("name");var userType=Localstorage.get("userType")||"user";$scope.currentUser=data.fBase.currentUser,"dashboard"==userType&&$location.path("/dashboard"),$scope.saveName=function(name){data.fBase.currentUser.$child("name").$set(name),$scope.name=name}}]),angular.module("12oder3App").factory("data",["$firebase","$http","$q","$rootScope","_","Localstorage","Uuids",function($firebase,$http,$q,$rootScope,_,Localstorage){function init(){var defer=$q.defer();fBase.playPage=$firebase(new Firebase(fBase.firebaseUrl+"playPage/")),fBase.playDashboard=$firebase(new Firebase(fBase.firebaseUrl+"playDashboard/")),fBase.activeQuestion=$firebase(new Firebase(fBase.firebaseUrl+"activeQuestion/")),fBase.playTimer=$firebase(new Firebase(fBase.firebaseUrl+"playTimer/")),fBase.questions=$firebase(new Firebase(fBase.firebaseUrl+"questions/")),fBase.users=$firebase(new Firebase(fBase.firebaseUrl+"users/")),fBase.votes=$firebase(new Firebase(fBase.firebaseUrl+"votes/"));var currentUserId=Localstorage.get("uuid");return currentUserId?(fBase.currentUser=$firebase(new Firebase(fBase.firebaseUrl+"users/"+currentUserId)),defer.resolve()):fBase.users.$add("newUser").then(function(ref){currentUserId=ref.name(),fBase.currentUser=$firebase(new Firebase(fBase.firebaseUrl+"users/"+currentUserId)),Localstorage.set("uuid",currentUserId),Localstorage.set("userType","user"),defer.resolve()}),defer.promise}var fBase={firebaseUrl:"https://12oder3.firebaseio.com/"};return{init:init,fBase:fBase,timeOut:10}}]),angular.module("12oder3App").factory("helpers",["Uuids","Localstorage",function(Uuids,Localstorage){return{getRandom:function(min,max){return Math.floor(Math.random()*(max-min+1)+min)},userType:function(type){var userType=Localstorage.get("userType")||"user";return-1!=userType.indexOf(type)}}}]),angular.module("12oder3App").service("Localstorage",function(){var STORAGE_ID="12oder3_",now=function(){return Math.round((new Date).getTime()/1e3)};return{get:function(item){var data=JSON.parse(localStorage.getItem(STORAGE_ID+item)||null);return data&&data.expires&&("never"==data.expires||data.expires>now())?data.data:(localStorage.removeItem(STORAGE_ID+item),null)},set:function(item,data,expire){var _expires=expire?expire+now():"never",dataToStore={data:data,expires:_expires};localStorage.setItem(STORAGE_ID+item,JSON.stringify(dataToStore))}}}),angular.module("lodash",[]).factory("_",["$window",function($window){return $window._}]),angular.module("12oder3App").factory("Uuids",function(){return{newuuid:function(){for(var s=[],hexDigits="0123456789abcdef",i=0;36>i;i++)s[i]=hexDigits.substr(Math.floor(16*Math.random()),1);return s[14]="4",s[19]=hexDigits.substr(3&s[19]|8,1),s[8]=s[13]=s[18]=s[23]="-",s.join("")}}}),angular.module("12oder3App").controller("AdminDashboardCtrl",["$scope","$document","$rootScope","Localstorage","$interval","$timeout","data","helpers",function($scope,$document,$rootScope,Localstorage,$interval,$timeout,data,helpers){function fakeVoting(){var question=data.fBase.activeQuestion,users=data.fBase.users;users.$on("loaded",function(){for(var array=users.$getIndex(),i=4;i>=0;i--)angular.forEach(_.shuffle(array),function(userId){var qid=question.$value;$timeout(function(){data.fBase.votes.$child(qid+"/"+userId).$set({vote:"a"+helpers.getRandom(1,3),team:helpers.getRandom(1,3)})},helpers.getRandom(20,5e3))})})}var stop;$document.find("body").addClass("admin"),$scope.timeOut=data.timeOut,$scope.questions=data.fBase.questions,$scope.usedQuestions=[],data.fBase.playTimer.$bind($scope,"playTimer"),data.fBase.playTimer.$set(data.timeOut+1),$scope.waitMode=function(){data.fBase.playDashboard.$set("/wait-dashboard"),data.fBase.playPage.$set("/wait"),data.fBase.activeQuestion.$set("none"),$interval.cancel(stop),stop=void 0},$scope.alocate=function(){var team=0;angular.forEach(data.fBase.users.$getIndex(),function(value){team=3===team?1:team+1,data.fBase.users.$child(value).$child("team").$set(team)})},$scope.usedQuestion=function(qid){return-1==$scope.usedQuestions.indexOf(qid)?!1:!0},$scope.reset=function(){data.fBase.users.$remove(),data.fBase.votes.$remove(),data.fBase.playPage.$set("/reset"),$timeout(function(){data.fBase.playDashboard.$set("/"),data.fBase.playPage.$set("/")},300)},$scope.setQuestion=function(qid){data.fBase.playPage.$set("/play/"+qid),data.fBase.playDashboard.$set("/play-dashboard/"+qid),data.fBase.activeQuestion.$set(qid),$scope.playTimer=data.timeOut+1},$scope.startTimer=function(qid){$scope.usedQuestions.push(qid),$interval.cancel(stop),stop=void 0,$scope.playTimer=data.timeOut,stop=$interval(function(){0==$scope.playTimer?($interval.cancel(stop),stop=void 0):$scope.playTimer-=1},1e3)},$scope.fakeVoting=fakeVoting,$scope.fakeUsers=function(){for(var i=70;i>=0;i--)$timeout(function(){var names="Austin, Camden, Cameron, Emmett, Griffin, Harrison, Hudson, Jace, Jonah, Kingston, Lincoln, Marcus, Nash, Nathan, Oliver, Parker, Ryan, Ryder, Seth, Xavier".split(", ");data.fBase.users.$add({name:names[helpers.getRandom(0,19)]+" "+names[helpers.getRandom(0,19)],score:helpers.getRandom(0,19)})},helpers.getRandom(20,5e3))}}]),angular.module("12oder3App").controller("AdminAddQuestionsCtrl",["$scope","Localstorage","data",function($scope,Localstorage,data){var emtyQuestion={question:"Question description",a1:"answer 1",a2:"answer 2",a3:"answer 3",correctAnswer:"a1",longAnswer:"",votes:0};$scope.questions=data.fBase.questions,$scope.remainingVotes=null==Localstorage.get("remainingVotes")?10:Localstorage.get("remainingVotes"),$scope.$watch("remainingVotes",function(newValue,oldValue){newValue!==oldValue&&Localstorage.set("remainingVotes",newValue)}),$scope.addQuestion=function(){$scope.questions.$add(emtyQuestion)},$scope.upVote=function(key){$scope.questions[key].votes+=1,$scope.questions.$save(key),$scope.remainingVotes-=1},$scope.downVote=function(key){$scope.questions[key].votes-=1,$scope.questions.$save(key),$scope.remainingVotes-=1},$scope.delete=function(key){$scope.questions.$remove(key)},$scope.save=function(key){$scope.questions.$save(key)},$scope.saveQuestions=function(){$scope.questions.$save()}}]),angular.module("12oder3App").controller("PlayCtrl",["$scope","$routeParams","$document","$location","Localstorage","audio","data","_",function($scope,$routeParams,$document,$location,Localstorage,audio,data){function testResponse(){var result=!1;if($scope.lastVote==$scope.correctAnswer){result=!0;var oldScore=$scope.userScore.$value||0;console.log((new Date).getTime(),"oldScore",oldScore,$scope.lastVote,$scope.correctAnswer);var newScore=oldScore+1;$scope.userScore.$set(newScore)}else console.log("Wrong Answer!");return result}var qid=$routeParams.qid,userId=Localstorage.get("uuid");$scope.timeOut=data.timeOut,$scope.userScore=data.fBase.currentUser.$child("score"),$scope.currentQuestion=data.fBase.questions.$child(qid),$scope.currentUser=data.fBase.currentUser,$scope.activeQuestion=data.fBase.activeQuestion,$scope.playTimer=data.fBase.playTimer.$value,$scope.timeOver=!1,data.fBase.playTimer.$on("change",function(){$scope.playTimer=data.fBase.playTimer.$value,0===$scope.playTimer&&(audio.src="sounds/horn.mp3",audio.play(),$scope.isItRight=testResponse(),$scope.timeOver=!0)}),$scope.currentUser.$on("loaded",function(){angular.element($document[0].querySelector(".team-bar")).addClass("team-"+$scope.currentUser.team)}),$scope.currentQuestion.$on("loaded",function(){console.log("$scope.correctAnswer",$scope.correctAnswer,(new Date).getTime()),$scope.correctAnswer=$scope.currentQuestion.correctAnswer}),$scope.vote=function(vote){$scope.lastVote=vote,data.fBase.votes.$child(qid+"/"+userId).$set({vote:vote,team:$scope.currentUser.team})}}]),angular.module("12oder3App").controller("SetUserTypeCtrl",["$scope","$routeParams","$location","Localstorage",function($scope,$routeParams,$location,Localstorage){"admin"==$routeParams.userType||"dashboard"==$routeParams.userType?(Localstorage.set("userType",$routeParams.userType),$location.path("/"+$routeParams.userType)):$location.path("/")}]),angular.module("12oder3App").controller("DashboardCtrl",["$scope","$location","Localstorage","data",function($scope,$location,Localstorage,data){$scope.users=data.fBase.users}]),angular.module("12oder3App").controller("PlayDashboardCtrl",["$scope","$routeParams","$location","$timeout","Localstorage","data",function($scope,$routeParams,$location,$timeout,Localstorage,data){{var qid=$routeParams.qid;Localstorage.get("uuid")}$scope.timeOut=data.timeOut,$scope.currentQuestion=data.fBase.questions.$child(qid),$scope.currentUser=data.fBase.currentUser,$scope.playTimer=data.fBase.playTimer.$value,$scope.currentVotes=data.fBase.votes.$child(qid),data.fBase.playTimer.$on("change",function(){$scope.playTimer=data.fBase.playTimer.$value,0==$scope.playTimer&&$timeout(function(){$scope.revealAnswer=!0},2e3)})}]),angular.module("12oder3App").controller("WaitDashboardCtrl",["$scope","$location","$timeout","$document","Localstorage","helpers","data",function($scope,$location,$timeout,$document,Localstorage,helpers,data){function preloadImage(url){var img=new Image;img.src=url}var totalScore=0;$scope.users=data.fBase.users,$scope.teamScore={},$scope.normalizedTeamScore={1:0,2:0,3:0};for(var result=[],i=9;i>=0;i--)result.push(helpers.getRandom(1,5));$scope.setRandomActive=result,$timeout(function(){[].forEach.call($document[0].querySelectorAll(".cube"),function(el){angular.element(el).addClass("set-face-6")})},1e4),$scope.shuffleCube=function(){return _shuffle([1,2,3,4,5])},$scope.users.$on("loaded",function(){var max_score=250,divide=1,teamScore={1:0,2:0,3:0},normalizedTeamScore={};angular.forEach($scope.users.$getIndex(),function(item){var userScore=$scope.users[item].score||0;1==$scope.users[item].team&&(teamScore[1]=teamScore[1]+userScore),2==$scope.users[item].team&&(teamScore[2]=teamScore[2]+userScore),3==$scope.users[item].team&&(teamScore[3]=teamScore[3]+userScore),totalScore+=item.score}),divide=max_score/Math.max(teamScore[1],teamScore[2],teamScore[3]),angular.forEach(teamScore,function(el,index){normalizedTeamScore[index]=Math.floor(el*divide)}),$scope.teamScore=teamScore,$scope.normalizedTeamScore=normalizedTeamScore});for(var i=1;9>=i;i++)for(var j=1;6>=j;j++)preloadImage("images/Images_cube/"+i+"/"+j+".jpg")}]),angular.module("12oder3App").controller("WaitCtrl",["$scope","$routeParams","$document","$location","Localstorage","audio","data","_",function($scope,$routeParams,$document,$location,Localstorage,audio,data){$scope.currentUser=data.fBase.currentUser,$scope.currentUser.$on("loaded",function(){console.log($scope.currentUser),$scope.userScore=$scope.currentUser.score})}]),angular.module("12oder3App").factory("audio",["$document",function($document){var audio=$document[0].createElement("audio");return audio}]),angular.module("12oder3App").controller("ResetCtrl",["$scope","$location","data","$timeout","Localstorage",function($scope,$location,data,$timeout,Localstorage){Localstorage.set("uuid",""),$timeout(function(){data.init()},100)}]);